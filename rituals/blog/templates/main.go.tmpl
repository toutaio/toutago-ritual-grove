package main

import (
	"fmt"
	"log"
	"net/http"
	"os"

	"[[ .module_path ]]/internal/handlers"
	"github.com/toutaio/toutago-cosan-router"
	"github.com/toutaio/toutago-fith-renderer"
	"github.com/toutaio/toutago-nasc-dependency-injector"
)

func main() {
	// Initialize DI container
	container := nasc.NewContainer()

	// Initialize FÃ­th renderer
	renderer := fith.NewRenderer("views")
	container.Register("renderer", renderer)

	// Initialize router
	router := cosan.NewRouter()

	// Register handlers
	postHandler := handlers.NewPostHandler(container)
	categoryHandler := handlers.NewCategoryHandler(container)
{{- if .enable_comments ]]
	commentHandler := handlers.NewCommentHandler(container)
{{- end ]]

	// Routes
	router.GET("/", postHandler.List)
	router.GET("/posts", postHandler.List)
	router.GET("/posts/:id", postHandler.Show)
	router.POST("/posts", postHandler.Create)
	router.PUT("/posts/:id", postHandler.Update)
	router.DELETE("/posts/:id", postHandler.Delete)

	router.GET("/categories", categoryHandler.List)
	router.GET("/categories/:id", categoryHandler.Show)

{{- if .enable_comments ]]
	router.POST("/posts/:id/comments", commentHandler.Create)
	router.DELETE("/comments/:id", commentHandler.Delete)
{{- end ]]

	// Static files
	router.Static("/public", "./public")

	// Start server
	port := os.Getenv("PORT")
	if port == "" {
		port = "[[ .port ]]"
	}

	addr := fmt.Sprintf(":%s", port)
	log.Printf("[[ .app_name ]] server starting on %s", addr)
	log.Fatal(http.ListenAndServe(addr, router))
}
