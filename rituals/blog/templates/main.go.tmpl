package main

import (
	"fmt"
	"log"
	"net/http"
	"os"

	"[[ .module_path ]]/internal/handlers"
	cosan "github.com/toutaio/toutago-cosan-router"
	nasc "github.com/toutaio/toutago-nasc-dependency-injector"
[[- if eq .frontend_type "inertia-vue" ]]
	"github.com/toutaio/toutago-inertia/pkg/inertia"
[[- else ]]
	fith "github.com/toutaio/toutago-fith-renderer"
[[- end ]]
)

func main() {
	// Initialize DI container
	container := nasc.New()

[[- if eq .frontend_type "inertia-vue" ]]
	// Initialize Inertia.js
	inertiaInstance, err := inertia.New(inertia.Config{
		RootView: "app",
		Version:  "1.0",
[[- if .enable_ssr ]]
		SSR:      true,
		AssetURL: "http://localhost:13714",
[[- end ]]
	})
	if err != nil {
		log.Fatalf("Failed to initialize Inertia: %v", err)
	}
[[- else ]]
	// Initialize FÃ­th renderer
	renderer, err := fith.NewWithDir("views")
	if err != nil {
		log.Fatalf("Failed to initialize renderer: %v", err)
	}
	// TODO: Register renderer in container if needed
	_ = renderer
[[- end ]]

	// Initialize router
	router := cosan.New()

	// Register handlers
[[- if eq .frontend_type "inertia-vue" ]]
	postHandler := handlers.NewPostHandler(container, inertiaInstance)
	categoryHandler := handlers.NewCategoryHandler(container, inertiaInstance)
[[- else ]]
	postHandler := handlers.NewPostHandler(container)
	categoryHandler := handlers.NewCategoryHandler(container)
[[- end ]]
[[- if .enable_comments ]]
	commentHandler := handlers.NewCommentHandler(container)
[[- end ]]

	// Routes
	router.GET("/", postHandler.List)
	router.GET("/posts", postHandler.List)
	router.GET("/posts/:id", postHandler.Show)
	router.POST("/posts", postHandler.Create)
	router.PUT("/posts/:id", postHandler.Update)
	router.DELETE("/posts/:id", postHandler.Delete)

	router.GET("/categories", categoryHandler.List)
	router.GET("/categories/:id", categoryHandler.Show)

[[- if .enable_comments ]]
	router.POST("/posts/:id/comments", commentHandler.Create)
	router.DELETE("/comments/:id", commentHandler.Delete)
[[- end ]]

	// Serve static files from /public
	router.GET("/public/*", func(c cosan.Context) error {
		http.StripPrefix("/public/", http.FileServer(http.Dir("./public"))).ServeHTTP(c.Response(), c.Request())
		return nil
	})

	// Start server
	port := os.Getenv("PORT")
	if port == "" {
		port = "[[ .port ]]"
	}

	addr := fmt.Sprintf(":%s", port)
	log.Printf("[[ .app_name ]] server starting on %s", addr)
	log.Fatal(http.ListenAndServe(addr, router))
}
