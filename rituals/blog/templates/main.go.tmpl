package main

import (
	"fmt"
	"log"
	"net/http"
	"os"

	"[[ .module_path ]]/internal/handlers"
	"github.com/toutaio/toutago-cosan-router"
	"github.com/toutaio/toutago-fith-renderer"
	"github.com/toutaio/toutago-nasc-dependency-injector"
)

func main() {
	// Initialize DI container
	container := nasc.New()

	// Initialize FÃ­th renderer
	renderer, err := fith.NewWithDir("views")
	if err != nil {
		log.Fatalf("Failed to initialize renderer: %v", err)
	}
	// TODO: Register renderer in container if needed
	_ = renderer

	// Initialize router
	router := cosan.New()

	// Register handlers
	postHandler := handlers.NewPostHandler(container)
	categoryHandler := handlers.NewCategoryHandler(container)
[[- if .enable_comments ]]
	commentHandler := handlers.NewCommentHandler(container)
[[- end ]]

	// Routes
	router.GET("/", postHandler.List)
	router.GET("/posts", postHandler.List)
	router.GET("/posts/:id", postHandler.Show)
	router.POST("/posts", postHandler.Create)
	router.PUT("/posts/:id", postHandler.Update)
	router.DELETE("/posts/:id", postHandler.Delete)

	router.GET("/categories", categoryHandler.List)
	router.GET("/categories/:id", categoryHandler.Show)

[[- if .enable_comments ]]
	router.POST("/posts/:id/comments", commentHandler.Create)
	router.DELETE("/comments/:id", commentHandler.Delete)
[[- end ]]

	// Serve static files from /public
	router.GET("/public/*", func(c cosan.Context) error {
		http.StripPrefix("/public/", http.FileServer(http.Dir("./public"))).ServeHTTP(c.Response(), c.Request())
		return nil
	})

	// Start server
	port := os.Getenv("PORT")
	if port == "" {
		port = "[[ .port ]]"
	}

	addr := fmt.Sprintf(":%s", port)
	log.Printf("[[ .app_name ]] server starting on %s", addr)
	log.Fatal(http.ListenAndServe(addr, router))
}
