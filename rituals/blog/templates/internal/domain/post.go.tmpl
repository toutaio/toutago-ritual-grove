package domain

import (
	"errors"
	"time"
)

// PostStatus represents the status of a blog post
type PostStatus string

const (
	PostStatusDraft     PostStatus = "draft"
	PostStatusPublished PostStatus = "published"
	PostStatusArchived  PostStatus = "archived"
)

// Post represents a blog post
type Post struct {
	ID            string      `json:"id"`
	Title         string      `json:"title"`
	Slug          string      `json:"slug"`
	Content       string      `json:"content"`
	Excerpt       string      `json:"excerpt"`
	FeaturedImage string      `json:"featured_image,omitempty"`
	AuthorID      string      `json:"author_id"`
	Author        *User       `json:"author,omitempty"`
	CategoryID    *string     `json:"category_id,omitempty"`
	Status        PostStatus  `json:"status"`
	PublishedAt   *time.Time  `json:"published_at,omitempty"`
	CreatedAt     time.Time   `json:"created_at"`
	UpdatedAt     time.Time   `json:"updated_at"`
}

// Validate ensures post data is valid
func (p *Post) Validate() error {
	if p.Title == "" {
		return errors.New("title is required")
	}
	if len(p.Title) > 255 {
		return errors.New("title too long (max 255 characters)")
	}
	if p.Slug == "" {
		return errors.New("slug is required")
	}
	if len(p.Slug) > 255 {
		return errors.New("slug too long (max 255 characters)")
	}
	if p.Content == "" {
		return errors.New("content is required")
	}
	if p.AuthorID == "" {
		return errors.New("author_id is required")
	}
	if p.Status != PostStatusDraft && p.Status != PostStatusPublished && p.Status != PostStatusArchived {
		return errors.New("invalid status")
	}
	return nil
}

// IsPublished returns true if post is published
func (p *Post) IsPublished() bool {
	return p.Status == PostStatusPublished && p.PublishedAt != nil
}

// IsDraft returns true if post is draft
func (p *Post) IsDraft() bool {
	return p.Status == PostStatusDraft
}

// IsArchived returns true if post is archived
func (p *Post) IsArchived() bool {
	return p.Status == PostStatusArchived
}

// CanBeEditedBy checks if user can edit this post
func (p *Post) CanBeEditedBy(user *User) bool {
	if user == nil {
		return false
	}
	// Admin can edit any post
	if user.IsAdmin() {
		return true
	}
	// Editor can edit any post
	if user.IsEditor() {
		return true
	}
	// Author can only edit their own posts
	if user.IsAuthor() && p.AuthorID == user.ID {
		return true
	}
	return false
}

// CanBeDeletedBy checks if user can delete this post
func (p *Post) CanBeDeletedBy(user *User) bool {
	// Same rules as edit for now
	return p.CanBeEditedBy(user)
}

// Category represents a blog category
type Category struct {
	ID          string    `json:"id"`
	Name        string    `json:"name"`
	Slug        string    `json:"slug"`
	Description string    `json:"description"`
	CreatedBy   string    `json:"created_by"`
	CreatedAt   time.Time `json:"created_at"`
	UpdatedAt   time.Time `json:"updated_at"`
}

// Validate ensures category data is valid
func (c *Category) Validate() error {
	if c.Name == "" {
		return errors.New("name is required")
	}
	if len(c.Name) > 100 {
		return errors.New("name too long (max 100 characters)")
	}
	if c.Slug == "" {
		return errors.New("slug is required")
	}
	if len(c.Slug) > 100 {
		return errors.New("slug too long (max 100 characters)")
	}
	return nil
}
