package middleware

import (
	"[[ .module_path ]]/internal/services"
	cosan "github.com/toutaio/toutago-cosan-router"
)

const (
	// ContextKeyUser is the context key for the authenticated user
	ContextKeyUser = "user"
)

// AuthMiddleware creates middleware that requires authentication
func AuthMiddleware(authService services.AuthService) cosan.HandlerFunc {
	return func(c cosan.Context) error {
		// Get session token from cookie
		token, err := c.Cookie("session_token")
		if err != nil || token == "" {
			return c.JSON(401, map[string]string{
				"error": "Unauthorized",
			})
		}

		// Verify session
		user, err := authService.VerifySession(c.Request().Context(), token)
		if err != nil {
			return c.JSON(401, map[string]string{
				"error": "Invalid or expired session",
			})
		}

		// Store user in context
		c.Set(ContextKeyUser, user)

		return c.Next()
	}
}

// OptionalAuthMiddleware adds user to context if authenticated, but doesn't require it
func OptionalAuthMiddleware(authService services.AuthService) cosan.HandlerFunc {
	return func(c cosan.Context) error {
		// Get session token from cookie
		token, err := c.Cookie("session_token")
		if err != nil || token == "" {
			// No session, continue without user
			return c.Next()
		}

		// Try to verify session
		user, err := authService.VerifySession(c.Request().Context(), token)
		if err == nil {
			// Store user in context if valid
			c.Set(ContextKeyUser, user)
		}

		return c.Next()
	}
}

// GuestMiddleware requires that the user is NOT authenticated
func GuestMiddleware(authService services.AuthService) cosan.HandlerFunc {
	return func(c cosan.Context) error {
		// Get session token from cookie
		token, err := c.Cookie("session_token")
		if err != nil || token == "" {
			// No session, user is guest - continue
			return c.Next()
		}

		// Verify session
		user, err := authService.VerifySession(c.Request().Context(), token)
		if err != nil {
			// Invalid session, user is guest - continue
			return c.Next()
		}

		// User is authenticated, redirect to dashboard
		if user != nil {
			return c.Redirect(302, "/admin/dashboard")
		}

		return c.Next()
	}
}
