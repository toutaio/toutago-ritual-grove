import * as esbuild from 'esbuild'
import vue from 'esbuild-plugin-vue3'

const isDev = process.argv.includes('--watch')
const isSSR = process.argv.includes('--ssr')
const isProd = process.env.NODE_ENV === 'production'

// Client-side build configuration
const clientConfig = {
  entryPoints: ['frontend/app.js'],
  bundle: true,
  outdir: 'public/build',
  publicPath: '/build',
  plugins: [vue()],
  define: {
    'process.env.NODE_ENV': JSON.stringify(isProd ? 'production' : 'development'),
  },
  minify: isProd,
  sourcemap: isDev || !isProd,
  splitting: true,
  format: 'esm',
  metafile: true,
  logLevel: 'info',
}

// SSR build configuration (if enabled)
const ssrConfig = {
  ...clientConfig,
  entryPoints: ['frontend/ssr.js'],
  outdir: 'build/ssr',
  platform: 'node',
  target: 'node18',
  format: 'cjs',
  splitting: false,
  publicPath: undefined,
}

async function build() {
  try {
    if (isDev) {
      // Development mode with watch
      const ctx = await esbuild.context(clientConfig)
      await ctx.watch()
      console.log('üëÄ Watching for changes...')
    } else {
      // Production build
      console.log('üî® Building client bundle...')
      const result = await esbuild.build(clientConfig)
      
      if (result.metafile) {
        console.log('üì¶ Build analysis:')
        const outputs = Object.keys(result.metafile.outputs)
        outputs.forEach(file => {
          const size = (result.metafile.outputs[file].bytes / 1024).toFixed(2)
          console.log(`  ${file}: ${size} KB`)
        })
      }
      
      if (isSSR) {
        console.log('üî® Building SSR bundle...')
        await esbuild.build(ssrConfig)
      }
      
      console.log('‚úÖ Build complete!')
    }
  } catch (error) {
    console.error('‚ùå Build failed:', error)
    process.exit(1)
  }
}

build()
