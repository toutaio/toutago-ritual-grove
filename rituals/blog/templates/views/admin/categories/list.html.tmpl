<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Categories - [[.app_name]]</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .admin-nav {
            background: #343a40;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .admin-nav a {
            color: #fff;
            text-decoration: none;
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            border-radius: 4px;
        }
        .admin-nav a:hover {
            background: #495057;
        }
        .admin-nav a.active {
            background: #007bff;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .category-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            transition: box-shadow 0.2s;
        }
        .category-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .category-card h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            color: #333;
        }
        .category-card .slug {
            color: #6c757d;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        .category-card .description {
            color: #495057;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        .category-card .actions {
            display: flex;
            gap: 0.5rem;
        }
        .action-btn {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            text-decoration: none;
        }
        .btn-edit {
            background: #007bff;
            color: white;
        }
        .btn-edit:hover {
            background: #0056b3;
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-delete:hover {
            background: #c82333;
        }
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        .form-group textarea {
            min-height: 100px;
        }
        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
    </style>
</head>
<body>
    <nav class="admin-nav">
        <a href="/admin">Dashboard</a>
        <a href="/admin/posts">Posts</a>
        <a href="/admin/users">Users</a>
        <a href="/admin/categories" class="active">Categories</a>
        <a href="/">View Site</a>
        <a href="/auth/logout" style="float: right;">Logout</a>
    </nav>

    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 1rem;">
        <div class="page-header">
            <h1>Manage Categories</h1>
            {{if can .current_user "create" "categories"}}
            <button onclick="showCreateModal()" class="btn btn-primary">Create Category</button>
            {{end}}
        </div>

        {{if .categories}}
        <div class="categories-grid">
            {{range .categories}}
            <div class="category-card">
                <h3>{{.Name}}</h3>
                <div class="slug">/{{.Slug}}</div>
                {{if .Description}}
                <div class="description">{{.Description}}</div>
                {{else}}
                <div class="description" style="color: #adb5bd; font-style: italic;">No description</div>
                {{end}}
                <div class="actions">
                    {{if can $.current_user "update" "categories"}}
                    <button onclick='showEditModal({{.ID}}, "{{.Name}}", "{{.Description}}")' class="action-btn btn-edit">Edit</button>
                    {{end}}
                    {{if can $.current_user "delete" "categories"}}
                    <button onclick='deleteCategory({{.ID}}, "{{.Name}}")' class="action-btn btn-delete">Delete</button>
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>
        {{else}}
        <div class="empty-state">
            <h3>No categories yet</h3>
            <p>Create your first category to organize your posts.</p>
            {{if can .current_user "create" "categories"}}
            <button onclick="showCreateModal()" class="btn btn-primary" style="margin-top: 1rem;">Create Category</button>
            {{end}}
        </div>
        {{end}}
    </div>

    <!-- Create/Edit Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Create Category</h2>
            <form id="categoryForm">
                <input type="hidden" id="categoryId" value="">
                
                <div class="form-group">
                    <label for="name">Name *</label>
                    <input type="text" id="name" name="name" required placeholder="e.g., Technology">
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" placeholder="Brief description of this category (optional)"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showCreateModal() {
            document.getElementById('modalTitle').textContent = 'Create Category';
            document.getElementById('categoryId').value = '';
            document.getElementById('name').value = '';
            document.getElementById('description').value = '';
            document.getElementById('categoryModal').classList.add('active');
        }

        function showEditModal(id, name, description) {
            document.getElementById('modalTitle').textContent = 'Edit Category';
            document.getElementById('categoryId').value = id;
            document.getElementById('name').value = name;
            document.getElementById('description').value = description || '';
            document.getElementById('categoryModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }

        document.getElementById('categoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('categoryId').value;
            const data = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value || undefined
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/admin/categories/${id}` : '/api/admin/categories';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    return response.json().then(data => {
                        alert('Error: ' + (data.error || 'Failed to save category'));
                    });
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        });

        function deleteCategory(id, name) {
            if (!confirm(`Are you sure you want to delete "${name}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            fetch(`/api/admin/categories/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    return response.json().then(data => {
                        alert('Error: ' + (data.error || 'Failed to delete category'));
                    });
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }

        // Close modal when clicking outside
        document.getElementById('categoryModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
