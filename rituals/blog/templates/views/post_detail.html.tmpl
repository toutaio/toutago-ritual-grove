[[ define "content" ]]
<article class="post">
    <div class="post-header">
        <h1>[[ .Post.Title ]]</h1>
        <div class="post-actions">
            {{if canEdit .current_user "posts" .Post.AuthorID}}
            <a href="/admin/posts/[[ .Post.ID ]]/edit" class="btn btn-edit">Edit Post</a>
            {{end}}
            {{if canDelete .current_user "posts" .Post.AuthorID}}
            <button onclick="deletePost([[ .Post.ID ]])" class="btn btn-delete">Delete Post</button>
            {{end}}
            {{if and (eq .Post.Status "draft") (can .current_user "publish" "posts")}}
            <button onclick="publishPost([[ .Post.ID ]])" class="btn btn-publish">Publish</button>
            {{end}}
        </div>
    </div>
    
    <div class="post-meta">
        <span class="date">[[ .Post.PublishedAt.Format "January 2, 2006" ]]</span>
        <span class="author">by [[ .Post.Author.Name ]]</span>
        {{if .Post.Category}}
        <span class="category">in <a href="/categories/[[ .Post.Category.Slug ]]">[[ .Post.Category.Name ]]</a></span>
        {{end}}
        {{if ne .Post.Status "published"}}
        <span class="status status-[[ .Post.Status ]]">[[ .Post.Status ]]</span>
        {{end}}
    </div>
    
    <div class="post-content">
        [[- if .enable_markdown ]]
        [[ .Post.ContentHTML ]]
        [[- else ]]
        [[ .Post.Content ]]
        [[- end ]]
    </div>

    {{if .Post.Tags}}
    <div class="post-tags">
        <strong>Tags:</strong>
        {{range .Post.Tags}}
        <a href="/tags/{{.Slug}}" class="tag">{{.Name}}</a>
        {{end}}
    </div>
    {{end}}

[[- if .enable_comments ]]
    <div class="comments">
        <h3>Comments ({{len .Comments}})</h3>
        {{if .Comments}}
        [[ range .Comments ]]
        <div class="comment">
            <div class="comment-header">
                <p class="comment-author">[[ .Author ]]</p>
                <p class="comment-date">[[ .CreatedAt.Format "Jan 2, 2006 at 3:04pm" ]]</p>
                {{if can $.current_user "delete" "comments"}}
                <button onclick="deleteComment([[ .ID ]])" class="btn-delete-comment">Delete</button>
                {{end}}
            </div>
            <div class="comment-content">[[ .Content ]]</div>
        </div>
        [[ end ]]
        {{else}}
        <p class="no-comments">No comments yet. Be the first to comment!</p>
        {{end}}

        {{if can .current_user "create" "comments"}}
        <form method="POST" action="/posts/[[ .Post.ID ]]/comments" class="comment-form">
            <h4>Leave a Comment</h4>
            <input type="text" name="author" placeholder="Your name" value="{{if .current_user}}{{.current_user.Name}}{{end}}" required>
            <input type="email" name="email" placeholder="Your email" value="{{if .current_user}}{{.current_user.Email}}{{end}}" required>
            <textarea name="content" placeholder="Your comment" required></textarea>
            <button type="submit" class="btn btn-primary">Post Comment</button>
        </form>
        {{else}}
        <p class="login-message">Please <a href="/auth/login?redirect=/posts/[[ .Post.Slug ]]">login</a> to leave a comment.</p>
        {{end}}
    </div>
[[- end ]]
</article>

<style>
.post-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}
.post-actions {
    display: flex;
    gap: 0.5rem;
}
.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    font-size: 0.875rem;
}
.btn-edit {
    background: #28a745;
    color: white;
}
.btn-edit:hover {
    background: #218838;
}
.btn-delete {
    background: #dc3545;
    color: white;
}
.btn-delete:hover {
    background: #c82333;
}
.btn-publish {
    background: #007bff;
    color: white;
}
.btn-publish:hover {
    background: #0056b3;
}
.btn-primary {
    background: #007bff;
    color: white;
}
.btn-primary:hover {
    background: #0056b3;
}
.status {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}
.status-draft {
    background: #ffc107;
    color: #000;
}
.status-archived {
    background: #6c757d;
    color: white;
}
.post-tags {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #dee2e6;
}
.tag {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    margin-right: 0.5rem;
    background: #e9ecef;
    border-radius: 12px;
    text-decoration: none;
    color: #495057;
    font-size: 0.875rem;
}
.tag:hover {
    background: #dee2e6;
}
.comment {
    border-bottom: 1px solid #dee2e6;
    padding: 1rem 0;
}
.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}
.btn-delete-comment {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.btn-delete-comment:hover {
    background: #c82333;
}
.no-comments {
    color: #6c757d;
    font-style: italic;
    padding: 1rem 0;
}
.login-message {
    padding: 1rem;
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    border-radius: 4px;
    margin-top: 1rem;
}
.comment-form {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 2px solid #dee2e6;
}
</style>

<script>
function deletePost(id) {
    if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/posts/${id}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.href = '/';
        } else {
            return response.json().then(data => {
                alert('Error: ' + (data.error || 'Failed to delete post'));
            });
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function publishPost(id) {
    if (!confirm('Are you sure you want to publish this post?')) {
        return;
    }
    
    fetch(`/api/posts/${id}/publish`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            return response.json().then(data => {
                alert('Error: ' + (data.error || 'Failed to publish post'));
            });
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function deleteComment(id) {
    if (!confirm('Are you sure you want to delete this comment?')) {
        return;
    }
    
    fetch(`/api/comments/${id}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            return response.json().then(data => {
                alert('Error: ' + (data.error || 'Failed to delete comment'));
            });
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}
</script>
[[ end ]]
